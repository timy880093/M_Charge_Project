pipeline {
 agent any
 stages {
    stage('Build War') {
        agent {
            docker {
                image 'maven:3.6.3-jdk-8'
                args '-v $HOME/.m2:/root/.m2 -v /path/to/your/target:${WORKSPACE}/target'
            }
        }
        steps {
            sh 'mvn clean package'
        }
    }
    stage('Build Image') {
        agent{
            docker{
              image 'docker'
              args '-v /var/run/docker.sock:/var/run/docker.sock -v /path/to/your/target:/workspace/target'
              reuseNode true
            }
        }
        steps {
              script {
                  // 創建一個 Docker volume
                  sh "docker volume create myworkspace"
                  // 將 Workspace 目錄複製到 Docker volume
                  sh "docker run --rm -v ${WORKSPACE}/target:/source -v myworkspace:/target alpine cp -r /source /target"
              }
              script{
                  dockerImage = docker.build("egui/charge-system:${GIT_COMMIT}", "-f  ./Dockerfile .")
              }
        }
    }
 }
}