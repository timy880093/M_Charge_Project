pipeline {
 agent any
  environment{
     GIT_COMMIT="${env.GIT_COMMIT}"
     registryCredential = 'nexus-deploy'
  }
 stages {
    stage('Build War') {
        agent {
            docker {
                image 'maven:3.6.3-jdk-8'
                args '-v $HOME/.m2:/root/.m2 -v ${WORKSPACE}:/target'
                reuseNode true
            }
        }
        steps {
            sh 'mvn clean package'
        }
    }
    stage('Build Image') {
        agent{
            docker{
              image 'docker'
              args '-v ${WORKSPACE}:/target'
              reuseNode true
            }
        }
        steps {
              script{
                  sh "ls -l /target"
                  dockerImage = docker.build("gateweb/charge-system:${GIT_COMMIT}", "-f  ./Dockerfile .")
              }
        }
    }
    stage('Push image') {
        steps{
            script{
              docker.withRegistry('https://gw-nexus-docker.tweinv.com',registryCredential) {
                  dockerImage.push("${GIT_COMMIT}")
                  dockerImage.push('latest')
              }
            }
        }
    }
 }
}